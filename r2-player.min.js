class R2Player extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"});const t=document.createElement("div");t.classList.add("player-container"),this.video=document.createElement("video"),this.video.setAttribute("playsinline",""),this.video.setAttribute("preload","metadata"),t.appendChild(this.video),this.loadingSpinner=document.createElement("div"),this.loadingSpinner.classList.add("loading-spinner"),this.loadingSpinner.innerHTML='\n            <div class="spinner"></div>\n        ',t.appendChild(this.loadingSpinner),this.controlsContainer=document.createElement("div"),this.controlsContainer.classList.add("controls-container"),this.controlsContainer.innerHTML='\n            <button id="play-pause" class="control-button" aria-label="Play/Pause">►</button>\n            <div class="progress-container" id="progress-container">\n                <div class="buffered-bar" id="buffered-bar"></div>\n                <div class="progress-bar" id="progress-bar"></div>\n            </div>\n            <div class="controls-right">\n                <div class="volume-container">\n                    <button id="volume" class="control-button" aria-label="Mute/Unmute">🔊</button>\n                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" />\n                </div>\n                <button id="quality-button" class="control-button" aria-label="Change Quality">Auto</button>\n                <button id="fullscreen" class="control-button" aria-label="Fullscreen">⛶</button>\n            </div>\n            <div id="quality-menu" class="quality-menu">\n                <ul id="quality-options"></ul>\n            </div>\n        ',t.appendChild(this.controlsContainer),this.thumbnailPreview=document.createElement("div"),this.thumbnailPreview.id="thumbnail-preview",this.thumbnailPreview.classList.add("thumbnail-preview"),this.thumbnailPreview.innerHTML='<img id="thumbnail-image" src="" alt="Thumbnail">',t.appendChild(this.thumbnailPreview),this.shadowRoot.appendChild(t);const e=document.createElement("style");e.textContent="\n            /* General Styles */\n            :host {\n                display: inline-block;\n                position: relative;\n                width: var(--player-width, 800px);\n                height: var(--player-height, 450px);\n            }\n\n            .player-container {\n                position: relative;\n                width: 100%;\n                height: 100%;\n                background-color: #000;\n                border-radius: 10px;\n                overflow: hidden;\n                cursor: default;\n            }\n\n            video {\n                width: 100%;\n                height: 100%;\n                display: block;\n                background-color: #000;\n            }\n\n            /* Loading Spinner */\n            .loading-spinner {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                z-index: 20;\n                display: none;\n            }\n\n            .spinner {\n                border: 8px solid rgba(255, 255, 255, 0.3);\n                border-top: 8px solid #1db954;\n                border-radius: 50%;\n                width: 60px;\n                height: 60px;\n                animation: spin 1s linear infinite;\n            }\n\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n\n            /* Thumbnail Preview */\n            .thumbnail-preview {\n                position: absolute;\n                bottom: 70px;\n                width: 160px;\n                height: 90px;\n                pointer-events: none;\n                border: 1px solid #fff;\n                background-color: rgba(0, 0, 0, 0.7);\n                border-radius: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10;\n                opacity: 0;\n            }\n\n            .thumbnail-preview img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n                border-radius: 4px;\n            }\n\n            /* Custom Controls */\n            .controls-container {\n                position: absolute;\n                bottom: 0;\n                width: 100%;\n                background: rgba(0, 0, 0, 0.6);\n                display: flex;\n                align-items: center;\n                padding: 10px;\n                opacity: 1;\n                visibility: visible;\n                overflow: visible;\n            }\n\n            .controls-container.hidden {\n                opacity: 0;\n                visibility: hidden;\n            }\n\n            .control-button {\n                background: none;\n                border: none;\n                color: #fff;\n                font-size: 1.2em;\n                margin: 0 5px;\n                cursor: pointer;\n                transition: color 0.3s;\n            }\n\n            .control-button:hover {\n                color: #1db954;\n            }\n\n            .progress-container {\n                flex: 1;\n                height: 10px;\n                background: #555;\n                margin: 0 10px;\n                cursor: pointer;\n                position: relative;\n                border-radius: 5px;\n            }\n\n            .buffered-bar {\n                position: absolute;\n                top: 0;\n                left: 0;\n                height: 100%;\n                background: #999;\n                width: 0%;\n                border-radius: 5px;\n            }\n\n            .progress-bar {\n                position: absolute;\n                top: 0;\n                left: 0;\n                height: 100%;\n                background: #1db954;\n                width: 0%;\n                border-radius: 5px;\n            }\n\n            .controls-right {\n                display: flex;\n                align-items: center;\n                overflow: visible;\n            }\n\n            /* Volume Container */\n            .volume-container {\n                position: relative;\n                display: flex;\n                align-items: center;\n                margin-right: 10px;\n                overflow: visible;\n            }\n\n            #volume-slider {\n                position: absolute;\n                bottom: calc(100% + 10px);\n                left: 50%;\n                transform: translateX(-50%) rotate(-90deg);\n                transform-origin: center;\n                width: 100px;\n                height: 4px;\n                opacity: 0;\n                transition: opacity 0.3s ease;\n                background: #555;\n                border-radius: 2px;\n            }\n\n            /* Quality Menu */\n            .quality-menu {\n                position: absolute;\n                bottom: 50px;\n                right: 10px;\n                background-color: rgba(0, 0, 0, 0.9);\n                border: 1px solid #444;\n                border-radius: 4px;\n                width: 120px;\n                z-index: 1000;\n                display: none;\n            }\n\n            .quality-menu ul {\n                list-style: none;\n                margin: 0;\n                padding: 5px 0;\n            }\n\n            .quality-menu li {\n                padding: 8px 12px;\n                cursor: pointer;\n                color: #fff;\n                font-size: 0.9em;\n            }\n\n            .quality-menu li:hover {\n                background-color: rgba(255, 255, 255, 0.1);\n            }\n\n            .quality-menu li.active {\n                background-color: rgba(255, 255, 255, 0.2);\n            }\n\n            /* Fullscreen Button */\n            #fullscreen {\n                margin-left: 10px;\n            }\n\n            /* Responsive Adjustments */\n            @media (max-width: 600px) {\n                .controls-container {\n                    flex-direction: column;\n                    align-items: flex-start;\n                }\n\n                .controls-right {\n                    margin-top: 10px;\n                }\n\n                .volume-container {\n                    margin-right: 0;\n                }\n\n                .quality-menu {\n                    bottom: 60px;\n                    right: 5px;\n                }\n\n                .thumbnail-preview {\n                    bottom: 80px;\n                }\n            }\n        ",this.shadowRoot.appendChild(e),this.hls=null,this.availableQualities=[],this.currentQuality=-1,this.totalThumbnails=256,this.initializePlayer=this.initializePlayer.bind(this),this.initializeControls=this.initializeControls.bind(this),this.loadHlsScript=this.loadHlsScript.bind(this),this.mouseActivityTimeout=null,this.controlsVisible=!0,R2Player.hlsLoading||(R2Player.hlsLoading=null)}static get observedAttributes(){return["src","width","height","autoplay","controls-visible","muted","loop","thumbnails","volume","quality"]}attributeChangedCallback(t,e,i){e!==i&&R2Player.observedAttributes.includes(t)&&this.initializePlayer()}connectedCallback(){this.src=this.getAttribute("src")||"",this.width=this.getAttribute("width")||"800",this.height=this.getAttribute("height")||"450",this.autoPlay=this.hasAttribute("autoplay"),this.controlsAlwaysVisible="false"!==this.getAttribute("controls-visible"),this.muted=this.hasAttribute("muted"),this.loop=this.hasAttribute("loop"),this.thumbnailEnabled="false"!==this.getAttribute("thumbnails"),this.defaultVolume=parseFloat(this.getAttribute("volume"))||1,this.defaultQuality=this.getAttribute("quality")||"auto",this.style.setProperty("--player-width",`${this.width}px`),this.style.setProperty("--player-height",`${this.height}px`),this.video.muted=this.muted,this.video.loop=this.loop,this.video.volume=this.defaultVolume,this.controlsAlwaysVisible?(this.controlsContainer.style.display="flex",this.controlsContainer.classList.remove("hidden")):(this.controlsContainer.style.display="flex",this.controlsContainer.classList.add("hidden")),this.initializePlayer(),this.initializeControls()}disconnectedCallback(){this.hls&&this.hls.destroy()}loadHlsScript(){return window.Hls?Promise.resolve():(R2Player.hlsLoading||(R2Player.hlsLoading=new Promise(((t,e)=>{const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js",i.async=!0,i.onload=()=>{window.Hls?t():e(new Error("Hls.js failed to load."))},i.onerror=()=>e(new Error("Failed to load Hls.js script.")),document.head.appendChild(i)}))),R2Player.hlsLoading)}initializePlayer(){if(!this.src)return void console.error("No source provided for R2Player.");this.loadingSpinner.style.display="block";const t=`${this.src}/master.m3u8`,e=`${this.src}/thumbnails/thumb`;this.hls&&(this.hls.destroy(),this.hls=null),this.loadHlsScript().then((()=>{window.Hls&&window.Hls.isSupported()?(this.hls=new window.Hls({autoStartLoad:!0,startPosition:-1,maxBufferLength:30,debug:!1}),this.hls.loadSource(t),this.hls.attachMedia(this.video),this.hls.on(window.Hls.Events.MANIFEST_PARSED,(()=>{this.loadingSpinner.style.display="none",this.autoPlay&&this.video.play();const t=this.hls.levels;this.availableQualities=t.map(((t,e)=>({index:e,height:t.height,bitrate:t.bitrate}))),this.populateQualityMenu(),this.setInitialQuality()})),this.hls.on(window.Hls.Events.LEVEL_SWITCHED,((t,e)=>{this.currentQuality=e.level,this.updateQualityButton()})),this.hls.on(window.Hls.Events.ERROR,((t,e)=>{console.error("HLS.js error:",e),this.loadingSpinner.style.display="none"}))):this.video.canPlayType("application/vnd.apple.mpegurl")?(this.video.src=t,this.video.addEventListener("loadedmetadata",(()=>{this.loadingSpinner.style.display="none",this.autoPlay&&this.video.play(),this.availableQualities=[],this.populateQualityMenu()}))):(alert("Your browser does not support HLS."),this.loadingSpinner.style.display="none"),this.thumbnailEnabled?this.setupThumbnails(e):this.thumbnailPreview.style.display="none"})).catch((t=>{console.error("Failed to load Hls.js:",t),this.loadingSpinner.style.display="none",alert("Failed to load video playback library.")}))}initializeControls(){const t=this.shadowRoot.getElementById("play-pause"),e=this.shadowRoot.getElementById("progress-container"),i=this.shadowRoot.getElementById("progress-bar"),n=this.shadowRoot.getElementById("buffered-bar"),s=this.shadowRoot.getElementById("volume"),o=this.shadowRoot.getElementById("volume-slider"),l=this.shadowRoot.getElementById("quality-button"),a=this.shadowRoot.getElementById("quality-menu"),r=(this.shadowRoot.getElementById("quality-options"),this.shadowRoot.getElementById("fullscreen")),d=this.shadowRoot.querySelector(".player-container");this.autoPlay?t.textContent="❚❚":t.textContent="►",this.video.addEventListener("play",(()=>{t.textContent="❚❚"})),this.video.addEventListener("pause",(()=>{t.textContent="►"})),t.addEventListener("click",(()=>{this.video.paused||this.video.ended?this.video.play():this.video.pause()})),this.video.addEventListener("timeupdate",(()=>{if(this.video.duration){const t=this.video.currentTime/this.video.duration*100;i.style.width=`${t}%`}})),this.video.addEventListener("progress",(()=>{if(this.video.buffered.length>0&&this.video.duration){const t=this.video.buffered.end(this.video.buffered.length-1)/this.video.duration*100;n.style.width=`${t}%`}})),e.addEventListener("click",(t=>{const i=e.getBoundingClientRect(),n=(t.clientX-i.left)/i.width;this.video.currentTime=n*this.video.duration})),e.addEventListener("mousemove",(t=>{if(!this.video.duration)return;const i=e.getBoundingClientRect(),n=(t.clientX-i.left)/i.width*this.video.duration,s=Math.min(Math.floor(n/this.video.duration*this.totalThumbnails)+1,this.totalThumbnails);this.thumbnailPreview.querySelector("#thumbnail-image").src=`${this.src}/thumbnails/thumb${s}.webp`;const o=this.thumbnailPreview.offsetWidth;let l=t.clientX-d.getBoundingClientRect().left-o/2;const a=d.clientWidth;l<0?l=0:l+o>a&&(l=a-o),this.thumbnailPreview.style.left=`${l}px`,this.thumbnailPreview.style.opacity="1"})),e.addEventListener("mouseleave",(()=>{this.thumbnailPreview.style.opacity="0"})),s.addEventListener("click",(()=>{this.video.muted=!this.video.muted,this.updateVolumeIcon(s)})),this.updateVolumeIcon(s),o.addEventListener("input",(t=>{this.video.volume=t.target.value,this.video.muted=0==t.target.value,this.updateVolumeIcon(s)})),s.addEventListener("mouseenter",(()=>{o.style.opacity="1"})),o.addEventListener("mouseenter",(()=>{o.style.opacity="1"})),s.addEventListener("mouseleave",(()=>{setTimeout((()=>{o.matches(":hover")||s.matches(":hover")||(o.style.opacity="0")}),100)})),o.addEventListener("mouseleave",(()=>{setTimeout((()=>{o.matches(":hover")||s.matches(":hover")||(o.style.opacity="0")}),100)})),l.addEventListener("click",(t=>{t.stopPropagation(),a.style.display="block"===a.style.display?"none":"block"})),document.addEventListener("click",(()=>{a.style.display="none"})),a.addEventListener("click",(t=>{t.stopPropagation()})),r.addEventListener("click",(()=>{document.fullscreenElement?document.exitFullscreen():d.requestFullscreen().catch((t=>{alert(`Error attempting to enter fullscreen mode: ${t.message}`)}))})),this.video.addEventListener("ended",(()=>{t.textContent="►"})),this.controlsAlwaysVisible||(d.addEventListener("mousemove",this.showControls.bind(this)),d.addEventListener("mouseleave",this.hideControls.bind(this)),this.video.addEventListener("play",this.startMouseActivityWatcher.bind(this)),this.video.addEventListener("pause",this.showControls.bind(this)))}updateVolumeIcon(t){this.video.muted||0===this.video.volume?t.textContent="🔇":this.video.volume>0&&this.video.volume<=.5?t.textContent="🔉":t.textContent="🔊"}populateQualityMenu(){const t=this.shadowRoot.getElementById("quality-options");this.shadowRoot.getElementById("quality-button");t.innerHTML="";const e=document.createElement("li");e.textContent="Auto",e.dataset.level="-1",e.classList.add("active"),e.addEventListener("click",(()=>{this.setQuality(-1),this.setActiveQuality(e)})),t.appendChild(e),this.availableQualities.forEach((e=>{const i=document.createElement("li");i.textContent=`${e.height}p`,i.dataset.level=e.index,i.addEventListener("click",(()=>{this.setQuality(e.index),this.setActiveQuality(i)})),t.appendChild(i)}))}setQuality(t){this.hls?this.hls.currentLevel=-1===t?-1:t:alert("Cannot change quality in this browser.")}setActiveQuality(t){this.shadowRoot.getElementById("quality-options").querySelectorAll("li").forEach((t=>{t.classList.remove("active")})),t.classList.add("active"),this.shadowRoot.getElementById("quality-menu").style.display="none",this.updateQualityButton()}updateQualityButton(){const t=this.shadowRoot.getElementById("quality-button");if(-1===this.currentQuality)t.textContent="Auto";else{const e=this.availableQualities.find((t=>t.index===this.currentQuality));t.textContent=e?`${e.height}p`:"Auto"}}setInitialQuality(){if("high"===this.defaultQuality)this.setQuality(this.availableQualities.length-1);else if("low"===this.defaultQuality)this.setQuality(0);else if(parseInt(this.defaultQuality)){const t=this.availableQualities.find((t=>t.height===parseInt(this.defaultQuality)));t&&this.setQuality(t.index)}else this.setQuality(-1)}setupThumbnails(t){const e=this.shadowRoot.getElementById("progress-container"),i=this.thumbnailPreview,n=this.shadowRoot.getElementById("thumbnail-image"),s=this.shadowRoot.querySelector(".player-container");e.addEventListener("mousemove",(o=>{if(!this.video.duration)return;const l=e.getBoundingClientRect(),a=(o.clientX-l.left)/l.width*this.video.duration,r=Math.min(Math.floor(a/this.video.duration*this.totalThumbnails)+1,this.totalThumbnails);n.src=`${t}${r}.webp`;const d=this.thumbnailPreview.offsetWidth;let h=o.clientX-s.getBoundingClientRect().left-d/2;const u=s.clientWidth;h<0?h=0:h+d>u&&(h=u-d),i.style.left=`${h}px`,i.style.opacity="1"})),e.addEventListener("mouseleave",(()=>{i.style.opacity="0"}))}showControls(){this.controlsVisible?clearTimeout(this.mouseActivityTimeout):(this.controlsContainer.classList.remove("hidden"),this.controlsVisible=!0),clearTimeout(this.mouseActivityTimeout),this.mouseActivityTimeout=setTimeout((()=>{this.hideControls()}),3e3)}hideControls(){this.controlsContainer.classList.add("hidden"),this.controlsVisible=!1}startMouseActivityWatcher(){this.showControls(),this.video.addEventListener("mousemove",this.showControls.bind(this))}}customElements.define("r2-player",R2Player);
